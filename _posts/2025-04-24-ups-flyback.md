---
layout: post
title: 直流 UPS 功能的电源
tags: [UPS, PCB, FlyBack]
---

# 恒流恒压模式和电池的充电原理

开关电源分恒压模式，和恒流恒压模式两种。区别就在于，负载消耗的电流超过了电源的供电能力时电源的应对策略。 恒压电源会立即切断输出进入保护模式。可能可以经过一段时间的等待后重新打开输出。即 “打嗝模式”。而恒流恒压模式下，电源会减小输出电压，直到负载消耗的电流小于设定值。适用于负载电流会随着电压的降低而降低的情况使用。例如，充电。

电池是一个电压源，它自身的内阻极小。因此，如果外部电压低于电池，电池就会放电，以稳定电压。如果外界电压高于电池，电池则会充电，以稳定电压。
充电电流的大小，可以用 （电源电压-电池电压）/电池内阻 计算。而电池的内阻极小，电压会随着充电进行逐步提升，因此充电器需要有“恒压恒流”模式。

首先输出电池的满电电压，然后设定一个最大的电流。和电池并联后，开关电源的电压大于电池电压（除非是满电状态）再加上电池内阻很小，充电器会输出一个很大的电流。此时充电器立即进入恒流模式。降低输出电压，直到电流等于设定的电流就不再降低电压。

# 同时并联运行负载和对电池充电

如果负载消耗的是 直流电，那么将电池逆变成 220v 然后再由负载的电源转换为直流电，这对电池存储的能量无疑是巨大的浪费。而且电池的容量非常昂贵。因此，在低压系统里，最佳的 UPS 实践方法，是直接并联一组 12V 电池进行供电。当开关电源的输出消失，就是电池立即填补输出的时候。

但是，在 直接并联电池当 UPS 的12V 低压供电系统里，如果使用 12v 恒流恒压电源直接对负载供电并且并联一个电池，则无法控制电池的充电电流。
只要电池未进入涓流充电模式，那么电池总是倾向于吃完电源的输出电流。迫使电源进入恒流模式。
因此，充电电流总是会被动的设置为 充电器的输出电流 - 负载消耗电流。
如果负载消耗的电流是一个定数，倒是可以设定 $充电器的输出电流 = 负载消耗的定数电流 + 期望的充电电流。$

然而，现实中，负载的电流消耗总是波动的。而如果负载消耗电流波动较大，例如负载最大可消耗 10A 电流的情况下，就需要设置恒流 10A输出。这意味着电池最大必须接受 10A 的充电电流。必须假定负载有可能不消耗任何电流。而如果不配置 10A 的充电器，那么可能会在极端情况下，即使没有停电也会导致电池越用越没电。

因此，我们需要设计一种特殊的充电器，它只有一路 12V 输出，电池和负载并联到一起。但是却可以同时监控负载和电池的电流。总输出进行恒压恒流模式的同时，对冲入电池的电也加恒压恒流模式。
它的输出电压会维持在恰好满足负载的供电，并且对电池进行恒流恒压模式充电。也就是说，如果设定充电电流为 1A 。那么充电器会恰好输出电压使得电流 = 1A + 负载消耗电流。如果电池已经进入恒压充电阶段，则正好输出电池满电电压。即便负载的电流从 0A 到 10A 变化，也不会用更大的电流对电池充电。
这样的 UPS ，在电池亏电的情况下，就不会盲目的以最大电流模式输出，以期电池能吸纳剩余电流。也不需要特意配置一个小功率充电器限制电池充电电流又导致极端下电池边充边掉电。
而是可以恰到好处的按设定电流充电，而不管充电器本身的电流输出能力是多少。

# 实现原理

UPS 的原理是：
充电器为两路并联的 12V 输出。2个输出在内部是并联的，由同一个变压器绕组供电。
电池和输出实际上是并联的，因此停电后，电池会立即放电为负载供电。中间没有任何切换延迟。

同时进行电池限流的原理是：

输出虽然是并联的，但是使用了2个采样电阻分别采样两路输出的电流大小。
整个电源的输出部分，就有 恒压反馈，负载恒流反馈，电池恒流反馈，这三个负反馈控制环路。

输出电压由 PWM 的占空比控制，而 PWM 占空比则由单个 负反馈控制环进行 三环竞争。任意一个环路要求降低 pwm 占空比，则 pwm 占空比就要降低。而 pwm 控制器内部，又有提高 pwm 占空比的内禀冲动。当三路反馈都没有要求降低占空比，则占空比缓慢增加。

电池充电过程中，电池的恒流控制环路起决定性作用。
电池充满后，稳压控制环路则起主导作用。
负载的恒流环，则正常来说几乎不起作用。主要起一个限制最大功率，保护电源的作用。

# 应用限制

负载需要能接受锂电池直接供电。因此需要适应锂电池满电到空电的电压变化（12.6v - 10v ），不能需要绝对稳定的12V供应。


# 星火计划

这样一个电源，想明白工作原理后，我就准备自己制作一个。但是做硬件是一件烧钱的事情。于是恰好看到了 嘉立创 搞的 “星火计划”。就报名参加了。主要是参加计划，可以报销在立创商城买耗材和在嘉立创打PCB的钱。当然，如果运气好能拿个千八百的安慰奖也很好。

## 进度

4月22日，UPS开关电源的计划审核通过。创建工程，将前期思考绘制到一半完成度的工作导入星火计划的专用工程并继续。这个工程源码会在计划完成后由嘉立创自动公开。（嗯，项目是必须开源的，方便后来者复刻。）
4月24日，原理图和PCB初稿绘制完毕。由于立创商城没有变压器的外壳和合适的高频变压器，需要在淘宝上单独购买。

-- 接下来的工作：

1：严格复核原理图，确保一次成功。星火计划只能报销一次打样的钱。如果有错误需修正，第二次打样可得自费了。得悠着点。
2：等外壳到货后，还得拿游标卡尺测量并对 pcb 进行微调，确保 打样回来的 pcb 能严丝合缝的装入外壳。并且不会发生 pcb上的元件和外壳干涩的事情。
3：打样并进行耗材经费申请。方法是先下单，然后申请经费。申请到经费后PCB订单就会变成0元支付。:）
4：等待PCB送达，然后编写单片机代码调试。
5：寄一台样机到嘉立创总部验收。


## 目前渲染的草图

正面：
![](/images/ups_flyback1.png)

背面：
![](/images/ups_flyback2.png)


## 用户交互的设计：

屏幕的左边有2个电位器。左边的电位器用于微调输出电压。输出电压的调节范围是 11v - 15v。
右边的电位器用于设定充电电流。充电电流的调节范围是 0-5A。

调节电压需要断开负载。拧动旋钮，屏幕上会实时显示当前的输出电压。
调节充电电流的旋钮，屏幕上也会实时显示设定的充电电流。

屏幕的显示应该是这样的：

```
Output: 12.6V/5A
Load: ?A
Bat: ?A
CurMODE: CC or CV
```



## 停电后的动作

为了节约电池电量。交流停电后，要关闭屏幕，单片机进入节能模式。除非用户按下唤醒按钮来点亮屏幕。


---

# 更新：

PQ2620变压器无货。是说现成的已经绕好的样品无货。我不想花大价钱打样变压器，也不想自己绕制。太累了。所以转而买了  PQ3230 规格的。有现货，适合 12V9A 的开关电源的。

于是紧急修改设计。好在 PQ3230 也没有大多少，微调下元件布局就布的下了。

电源外壳到了，用游标卡尺测量了尺寸后，重新微调了一下 PCB 大小。对pcb边缘的元件还得诺腾一番，因为有干涩。这下算是定稿了。

准备在 4月28日，也就是周一这天，向嘉立创申请耗材。顺利的话喜欢5月份能打样回来一个完成品吧。

有了实际的外壳掂量在手里，又修改了下接口，把调整电位器放到最右侧。

![](/images/flyback_ups_v2.png)


# 更新2：

PQ2620 后来到了。PQ3230 和 PQ2620 都到手后，又拿外壳比了一下，发现 PQ3220太高了，会完全顶到外壳顶部，略微高了 0.5mm 。靠钢制外壳的弹性勉强是可以塞进去的。。
但是考虑到 PQ2620 还是到了，于是PCB设计由改回了 PQ2620 。

# 更新3：

4月29号终于定稿，提交了打样订单。然后申请耗材。等待耗材申请通过中。PCB+SMT+元件费用一共 1160 。不知道嘉立创要多久审核。估计要51以后了。


# 更新3
过了个 五丶一，耗材审核通过了。随后去 smt 订单页面，发现待支付的订单已经变成 0元了。马上点确认，立即支付，一气呵成。


估计 5月14日应该能拿到2块PCBA了。
