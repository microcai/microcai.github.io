---
layout: post
title: 准备制作直流UPS
tags: [DCUPS]
---

# 问题

现在很多需要停电维持工作的东西，其实都是直流供电的。比如监控。比如树莓派，比如路由器，比如光猫。

在万能的宝上搜索直流UPS，是能找到一些现成的产品。

但是，统统不是我设想中的那种工作方式。

我设想中的UPS，既不是后备式，也不是在线式。

    后备式UPS，在市电正常的情况下，电池处于充电状态。当检测到市电故障，则立即将输出切换到电池。
    在线式UPS，电池一直处于边冲边放状态。负载一直都是由电池供电。

后备式UPS，有切换延时问题。在线式UPS，能量过了好几道，效率太差。

我设想中的UPS，应该是这样子的

    负载和电池直接并联。电池不仅供电，还能负责稳压。
    充电器为负载供电的同时为电池充电。
    充电器的功率只要略大于负载的平均功率。负载短时的功率需求由电池提供（所谓稳压）
    电池尽量以恒流方式充电。也就让充电器的输出电流恰好等于电池的充电电流+负载的消纳电量

这看起来不还是在线式UPS吗？但是在线式UPS是输出电池逆变后的交流电。而直接和电池并联的在线式ups，并不需要逆变。省掉了逆变这一过程。

那万能的宝上卖的路由器UPS不是这样的吗？

看起来是，但是并不是。他们使用的还是在线式UPS架构，不过把逆变220v交流电的模块换成了从电池升压输出12v的模块。能量还是要经过  12v适配器->（ups充电器->电池->ups升压电路）->负载 这么一个过程。能量损失巨大。而且电池实际上充电的速度，取决于负载的消耗能力。负载消耗的大了，电池充电的就慢了。也就是没有做到让电池恒流充电。

另外也有使用后备式架构的直流UPS。他们使用2个12v适配器，一个为电池供电，一个为负载供电。市电故障的时候，立即切换到12v电池直接供电。这个能做到恒流充电了，但是需要制作2个12v开关电源了。成本上升。

而且，统统有一个问题：没有48v版。

为啥需要48v呢？因为 POE。家里需要UPS的设备，全部都是从 POE 交换机取电的。路由器，用 poe 供电。光猫，用 poe 供电。 AP，更是直接接到 POE 上。监控摄像头，也是 POE 供电。

整个供电的重任，就交到了POE交换机的手上。

而 POE 交换机，就是以 48v 蓄电池供电为基础设计的。
POE 的供电电压，54v，就是48v蓄电池的浮充电压。

# 解决办法

我当然不满足于只是制作一个48v的直流ups填补一下空白。

于是我想到了一个万能直流UPS，这个万能直流UPS是这样的

    1. 有2个端口。一个为充放电口，一个为电池接头
    2. 使用的时候，连线如下
```
开关电源 ====== 用电器
         ||
        万能UPS == 电池
```

    3. 万能UPS的充放电口，直接并联在开关电源和用电器的直流母线上。万能UPS的唯一功能，是对流入电池的电流进行限流。也就是进行恒流充电。
    4. 如果充电器无输出，则电池可以直接从万能UPS直通用电器。
    5. 开关电源的输出电压，应该为电池的满电电压

也就是万能UPS，正向工作为Buck 降压恒流模式，反向为直通模式。而且只需要恒流，不需要知道电池的电压。只要适配器的输出电压为电池的满电电压即可。

实际上，一个简单的带恒流功能的 DCDC 降压模块，就能完成这个万能UPS的工作。除了。。。。一个小问题。

# 难倒了

为了减少损害，反向工作的时候，不能依赖开关管的寄生二极管实现自动反向，而应该让 mos 管直接持续导通。
而且为了实现电池接近满电后，buck电路的输入电压=输出电压，也需要让 buck 电路的pwm占空比达到 100%。

而 buck 的mos管，乃是一个“高侧”的 nmos 管。
让高侧的 NMOS 管 100% 占空比导通，并不是一件容易的事情。

诶，找了许久也没找到合适的 dcdc芯片。

# 更新

[直流UPS大功告成](https://www.bilibili.com/video/BV1WrESzVEAx)

一年多后，我总算有了足够的知识，把这个心心念念的 UPS 制作完成了。

过程看 [参加星火计划2025](https://microcai.org/2025/04/24/ups-flyback.html)

